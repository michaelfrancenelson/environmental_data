---
title: "ECo 634 - Analysis of Environmental Data Lab"
subtitle: "Lab 03: Data Exploration and Deterministic Functions"
author: "Michael France Nelson"
date: "Fall 2020"
output:
  # pdf_document:
  #   toc: true
  #   number_sections: TRUE
  html_document:
    theme: readable
    css: !expr here::here("formatting", "css", "eco_602_2020.css")
    toc: TRUE
    toc_float: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
require(here)
require(rmd.utils)
require(mfn.teaching.utils)
knitr::opts_chunk$set(echo = TRUE)

dat_bird = read.csv(here("data", "bird.sta.csv"))
dat_habitat = read.csv(here("data", "hab.sta.csv"))
dat_all = merge(dat_bird, dat_habitat)

# devtools::install_github("michaelfrancenelson/rmd.utils", force = TRUE)


```




```{r build_lab_page, eval=FALSE, include=FALSE}
lab = 3
sprintf("lab_%0.2d_", lab)

lab_source_dir = find_file(sprintf("lab_%0.2d_", lab), directory = TRUE)
lab_out_dir    = here::here("docs", "assignments", "eco_634")
lab_source_file = find_file(sprintf("lab_%0.2d", lab), search_path = lab_source_dir, extension = ".Rmd")

question_source_files = find_file(
  "", search_path = file.path(lab_source_dir, "moodle"), 
  return_all = TRUE, extension = ".Rmd")

lab_file_out = file.path(lab_out_dir, sprintf("lab_%0.2d", lab))

build_assignment_doc(
  lab_source_file,
  question_source_files,assignment_render_file = lab_file_out, key_render_file = here::here("docs", "answer_keys", sprintf("lab_%0.2d_answer_key", lab))
)

exams::exams2moodle(
  file = question_source_files,
  verbose = TRUE,
  # dir = lab_dir,
  dir = here::here("docs", "moodle_quiz_questions"),
  name = sprintf("lab_%0.2d_moodle_questions", lab)
)

```



```{r build_lab_page, eval=FALSE, include=FALSE}

lab_source_dir = find_file("lab_03_", directory = TRUE)
lab_out_dir    = here::here("docs", "assignments", "eco_634")
lab_source_file = find_file("lab_03_", search_path = lab_source_dir, extension = ".Rmd")

question_source_files = find_file(
  "", search_path = file.path(lab_source_dir, "moodle"), 
  return_all = TRUE, extension = ".Rmd")

lab_file_out = file.path(lab_out_dir, "lab_03")

build_assignment_doc(
  lab_source_file,
  question_source_files,assignment_render_file = lab_file_out, key_render_file = here::here("docs", "answer_keys", "lab_03_answer_key")
)

exams::exams2moodle(
  file = question_source_files,
  verbose = TRUE,
  # dir = lab_dir,
  dir = here::here("docs", "moodle_quiz_questions"),
  name = "lab_03_moodle_questions"
)

```




# Learning objectives, technical sills and concepts:

- Data exploration
- Deterministic function: the logistic curve
- Pretty pair plots




# Introduction to Lab 3

This lab is an extension of the individual assignment 'Data Exploration and Deterministic Functions' from the lecture course.

I suggest you work through the lecture assignment instructions and questions before proceeding.



# Nicer pairplots

The `psych` package has a function, `pairs.panels()` which produces very nice looking pairplots.

Install `psych` and try it out with the iris dataset!

```{r}
require(psych)
pairs.panels(iris)

```





# Data

You'll need the bird census data, in addition to the habitat data you use for the lecture questions, for these lab questions.  Make sure these data files are saved in the `data` subdirectory of your course RProject.

- <a href="https://michaelfrancenelson.github.io/eco_602_634_2020/data/bird.sta.csv">bird.sta.csv</a>
- <a href="https://michaelfrancenelson.github.io/eco_602_634_2020/data/hab.sta.csv">hab.sta.csv</a>

Here is the metadata, which describes the data and decodes the names of the columns:

- <a href="https://michaelfrancenelson.github.io/eco_602_634_2020/data/birdhab_metadata.pdf">birdhab_metadata.pdf</a>



Use `here()` and `read.csv()` to read `bird.sta.csv` into a `data.frame` called `dat_bird` and `hab.sta.csv` into a `data.frame` called `dat_habitat`.



# Merge the data

The two data files contain information about sampling locations and we'd like to be able to analyze both the bird count data and the habitat data.  

We can combine both data sets into a new data frame, but we need to be careful:

- How do we know that there are the same number of rows in both data frames?
- How can we be sure that we associate the correct row of `dat_habitat` and `dat_birds`?

### The `merge()` function

The two data sets have several columns in common (which ones? that will allow us to combine them and ensure that each row in `dat_birds` is associated with the correct row in `dat_habitat`.  

Build a new data.frame called `dat_all` using the `merge()` function with `dat_birds` and `dat_habitat`.


You can test that your merge operation was successful by recreating this scatterplot with the code given below:

```{r}
plot(ba.tot ~ elev, data = dat_all)
```




# Convert bird data to presence/absence.

You may have noticed that there a lot of zeroes in the bird census data.

For sample, here are counts of Cedar Waxwings at 100 randomly sampled sites:
```{r}
sample(dat_all$CEWA, 100)
```
Note: I had to run that code multiple times on my computer before I saw any non-zero entries! You should try running it on your machine several times on your machine to get an idea of how few sampling sites had cedar waxwings!

In fact, a total of only 116 cedar waxwings were observed at 53 (out of 1046) of sites!

<div class="blackborder">
Challenge: How could I use R to calculate the total number of waxwings and the number of sites in which they were present?

- These are slightly different questions, each requiring slightly different code.
</div>



## Presence/Absence

Since there are so many zeroes, it may be useful to think about bird presence/absence instead of counts.


You've created Boolean vectors using the equality test operator `==` in previous assignments:

```{r}
my_vec = rep(1:3, 5)
my_vec == 3
```

You could also use the greater than test to select the elements that are greater than 1:
```{r}
my_vec > 1
```

Use this as a template to write R code to build Boolean vector from the column of count data for cedar waxwings.

Your Boolean vector should have `TRUE` values for each sampling location where at least one bird was observed, and `FALSE` for each sampling location where the bird was absent.


## Data type coercion

Here's a cool trick to *coerce* a Boolean vector into a vector of ones and zeroes:

```{r}
as.numeric(my_vec > 1)
```
VoilÃ !

Use the same strategy to convert your Boolean presence/absence vector for cedar waxwings into a numeric vector.  Let's call it `cewa_present_absent`.

```{r include = FALSE}
cewa_present_absent = as.numeric(dat_all$CEWA > 0)
```

To test whether you have successfully built `cewa_present_absent`, run the following code to re-create the plot below:

```{r}
plot(x = dat_all$elev, y = cewa_present_absent)
```


How would you interpret the plot?  Is elevation a good predictor of whether cedar waxwings are present?

NOTE: our visual intuition is a powerful tool, but it's not a foolproof.  We can miss real patterns, and see patterns that aren't really there!  Think about how much an electrical outlet looks like a face.




# Fitting a logistic curve.

## The shape of the curve:

Review the description of the logistic function in McGarigal chapter 4.  Pay special attention to the figures on pages 7 and 17 that shows how the parameters a and b relate to the shape and position of the curve.  (Also note that the use of the parameters on the two figures is not consistent.)

Key things to notice about the logistic curve:

- You can slide the logistic curve to the right or left.  Think this as moving its **midpoint**.
- You can make the curve steeper or shallower near its midpoint.  Think of this as the **slope**.


## Visually estimating the parameters of the curve

Recall the functions for visually parameterizing a linear function from the in-class coding activity?

Here are a set of functions that you can use to do the same with a logistic curve:

<div class="grayborder">
You can find the equations and figures I used to build these parameterization functions in the McGarigal *Deterministic Functions* chapter (page 17).
</div>


```{r}

# Function to calculate the logistic parameter a given the slope and midpoint
get_logistic_param_a = function(slope, midpoint)
{
  b = slope / 4
  return (-midpoint * (slope / 4))
}

# Function to calculate the logistic parameter b given the slope
get_logistic_param_b = function(slope)
{
  return (slope / 4)
}


# Calculate the value of the logistic function at x, given the parameters a and b.
logistic = function(x, a, b)
{
  val = exp(a + b * x)
  return(val / (1 + val))
}

# Calculate the value of the logistic function at x, given a slope and midpoint.
logistic_midpoint_slope = function(x, midpoint, slope)
{
  b = get_logistic_param_b(slope)
  a = get_logistic_param_a(slope, midpoint)
  return(logistic(x, a, b))
}

```


Let's try to plot a logistic curve.  It looks like a good midpoint value could be 400.  We can try a slope of 0.1 to start with.


```{r}
plot(x = dat_all$elev, y = cewa_present_absent)
curve(logistic_midpoint_slope(x, midpoint = 400, slope = 0.1), add = TRUE)
```

Let's try a negative slope:

```{r}
plot(x = dat_all$elev, y = cewa_present_absent)
curve(logistic_midpoint_slope(x, midpoint = 400, slope = -0.1), add = TRUE)
```
Let's try a shallower negative slope:

```{r}
plot(x = dat_all$elev, y = cewa_present_absent)
curve(logistic_midpoint_slope(x, midpoint = 400, slope = -0.05), add = TRUE)
```

Does elevation look like a good predictor of cedar waxwing presence/absence?

Perhaps a different variable would better explain the bird presence/absence.



```{r, include = FALSE}
plot(x = dat_all$ba.tot, y = dat_all$CEWA > 0)
curve(logistic_midpoint_slope(x, midpoint = 31, slope = -1), add = TRUE)
```



# Instructions and Deliverables

1. Use the pair plot function from `psych` to create a pair plot of the three terrain variable and basal area from the lecture questions.
1. Choose two bird species and create plots of presence/absence (on the y-axis) and basal area (on the x axes).
  - Visually inspect the plots and fit *logistic curves* using the parameterization functions provided above.
1. Answer the assignment questions and submit your final answers via Moodle.



# Lab Questions



